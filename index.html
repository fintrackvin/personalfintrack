<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack - Personal Finance Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#0b0f19',
                        },
                        brand: {
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-gray-900/80 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-brand-500/20">
                        <i class="fa-solid fa-wallet text-white text-sm"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight">FinTrack</span>
                </div>
                <div id="auth-section" class="flex items-center gap-4">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 hidden">
        
        <!-- Tabs -->
        <div class="flex space-x-1 bg-gray-900/50 p-1 rounded-xl mb-8 w-full max-w-md mx-auto border border-gray-800">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all duration-200 text-brand-500 bg-gray-800 shadow-sm">Dashboard</button>
            <button onclick="switchTab('bills')" id="tab-bills" class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-gray-200 transition-all duration-200">Recurring Bills</button>
            <button onclick="switchTab('forecast')" id="tab-forecast" class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-gray-200 transition-all duration-200">Forecast</button>
        </div>

        <!-- View: Dashboard -->
        <div id="view-dashboard" class="view-section space-y-6 animate-fade-in">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-sack-dollar text-4xl text-green-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">Net Cash (This Month)</p>
                    <h3 class="text-3xl font-bold text-white mt-2" id="dash-net-cash">$0.00</h3>
                    <p class="text-xs text-gray-500 mt-2">Income Received - Expenses Paid</p>
                </div>

                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-arrow-trend-down text-4xl text-red-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">Total Expenses Paid</p>
                    <h3 class="text-3xl font-bold text-white mt-2" id="dash-total-paid">$0.00</h3>
                    <p class="text-xs text-gray-500 mt-2">Includes Bills & Manual</p>
                </div>
                
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-clock text-4xl text-yellow-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">Pending Bills</p>
                    <h3 class="text-3xl font-bold text-white mt-2" id="dash-pending-bills">0</h3>
                    <p class="text-xs text-gray-500 mt-2">Due this month</p>
                </div>
            </div>

            <!-- Manual Expenses Section -->
            <div class="glass-panel rounded-2xl border border-gray-800 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-receipt text-gray-400"></i> Unplanned / Manual Expenses
                    </h2>
                    <button onclick="openExpenseModal()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm transition-colors border border-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Add Expense
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-900/50 uppercase text-xs font-semibold text-gray-500">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">Date</th>
                                <th class="px-4 py-3">Description</th>
                                <th class="px-4 py-3 text-right">Amount</th>
                                <th class="px-4 py-3 text-center rounded-r-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="manual-expenses-list" class="divide-y divide-gray-800">
                            <!-- Populated by JS -->
                            <tr><td colspan="4" class="text-center py-4 text-gray-600">Loading expenses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- View: Recurring Bills -->
        <div id="view-bills" class="view-section hidden space-y-6">
            <div class="flex justify-between items-center">
                <div class="space-y-1">
                    <h2 class="text-2xl font-bold">Recurring Bills</h2>
                    <p class="text-gray-400 text-sm">Manage your fixed monthly or semi-monthly obligations.</p>
                </div>
                <button onclick="openBillModal()" class="bg-brand-600 hover:bg-brand-500 text-white px-5 py-2.5 rounded-lg font-medium shadow-lg shadow-brand-500/20 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Add Bill
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="bills-list">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- View: Forecast -->
        <div id="view-forecast" class="view-section hidden space-y-6">
            <div class="glass-panel p-4 rounded-xl flex flex-col md:flex-row justify-between items-center gap-4 border border-gray-800">
                <div class="flex items-center gap-3">
                    <div class="p-3 bg-gray-800 rounded-lg text-brand-400">
                        <i class="fa-solid fa-sliders"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">Budget Settings</h3>
                        <p class="text-xs text-gray-400">Net Monthly Income & Payout Dates</p>
                    </div>
                </div>
                <button onclick="openSettingsModal()" class="text-sm bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Edit Settings
                </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6" id="forecast-container">
                <!-- 3 Month Columns Injected Here -->
            </div>
        </div>

    </main>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-950 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-brand-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <h2 class="text-xl font-semibold text-white">FinTrack</h2>
            <p class="text-gray-500 text-sm mt-2">Loading your finances...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-950 flex items-center justify-center z-50 hidden">
        <div class="glass-panel p-8 rounded-2xl max-w-md w-full mx-4 text-center border border-gray-800 shadow-2xl">
            <div class="w-16 h-16 bg-brand-900/30 rounded-2xl flex items-center justify-center mx-auto mb-6 text-brand-500">
                <i class="fa-solid fa-wallet text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">Welcome Back</h1>
            <p class="text-gray-400 mb-8">Sign in to access your personal financial tracker and budget forecast.</p>
            
            <button id="btn-google-login" class="w-full bg-white text-gray-900 hover:bg-gray-100 font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-3 group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                <span>Continue with Google</span>
            </button>
            <p class="text-xs text-gray-600 mt-6">Secure authentication powered by Firebase</p>
        </div>
    </div>

    <!-- MODAL: Add/Edit Manual Expense -->
    <div id="modal-expense" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-white">Expense Details</h3>
            <input type="hidden" id="expense-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Description</label>
                    <input type="text" id="expense-desc" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="e.g. Grocery run">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Amount</label>
                        <input type="number" id="expense-amount" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Date</label>
                        <input type="date" id="expense-date" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('modal-expense')" class="flex-1 py-2.5 rounded-lg text-gray-300 hover:bg-gray-800 transition-colors">Cancel</button>
                <button onclick="saveExpense()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white font-medium py-2.5 rounded-lg transition-colors shadow-lg shadow-brand-600/20">Save</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Add/Edit Recurring Bill -->
    <div id="modal-bill" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Recurring Bill</h3>
                <button id="btn-delete-bill" onclick="deleteBill()" class="text-red-400 text-xs hover:underline hidden">Delete</button>
            </div>
            <input type="hidden" id="bill-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Bill Name</label>
                    <input type="text" id="bill-name" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="e.g. Internet">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Amount (Est.)</label>
                        <input type="number" id="bill-amount" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Day of Month Due</label>
                        <input type="number" id="bill-day" min="1" max="31" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="1-31">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Frequency</label>
                        <select id="bill-freq" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                            <option value="monthly">Monthly</option>
                            <!-- Semi-monthly logic handled by adding 2 bills or specific logic, keeping simple for now -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Termination (Optional)</label>
                        <input type="date" id="bill-end-date" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('modal-bill')" class="flex-1 py-2.5 rounded-lg text-gray-300 hover:bg-gray-800 transition-colors">Cancel</button>
                <button onclick="saveBill()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white font-medium py-2.5 rounded-lg transition-colors shadow-lg shadow-brand-600/20">Save Bill</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Settings (Income/Payout) -->
    <div id="modal-settings" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-white">Budget Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Total Net Monthly Income</label>
                    <input type="number" id="setting-income" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                </div>
                <div class="bg-gray-800/50 p-3 rounded-lg text-xs text-gray-400">
                    Income is split into two payouts (Semi-monthly).
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">1st Payout Day</label>
                        <input type="number" id="setting-day1" min="1" max="31" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">2nd Payout Day</label>
                        <input type="number" id="setting-day2" min="1" max="31" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('modal-settings')" class="flex-1 py-2.5 rounded-lg text-gray-300 hover:bg-gray-800 transition-colors">Cancel</button>
                <button onclick="saveSettings()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white font-medium py-2.5 rounded-lg transition-colors">Save</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Edit Actual Payout / Bill Payment -->
    <div id="modal-transaction" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-2 text-white" id="trans-modal-title">Confirm Transaction</h3>
            <p class="text-sm text-gray-400 mb-4" id="trans-modal-desc">Adjust the actual amount if different from projected.</p>
            
            <input type="hidden" id="trans-ref-id">
            <input type="hidden" id="trans-type"> <!-- 'income' or 'bill' -->
            <input type="hidden" id="trans-date">
            
            <div class="mb-4">
                <label class="block text-xs font-medium text-gray-400 mb-1">Actual Amount</label>
                <div class="relative">
                    <span class="absolute left-3 top-2.5 text-gray-500">$</span>
                    <input type="number" id="trans-amount" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-8 pr-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('modal-transaction')" class="flex-1 py-2.5 rounded-lg text-gray-300 hover:bg-gray-800 transition-colors">Cancel</button>
                <button onclick="confirmTransaction()" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-medium py-2.5 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyCWr-FADGeiUDxNokX0fdLubp-mnPZMhOM",
            authDomain: "fintrack-42a39.firebaseapp.com",
            databaseURL: "https://fintrack-42a39-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fintrack-42a39",
            storageBucket: "fintrack-42a39.firebasestorage.app",
            messagingSenderId: "748412377392",
            appId: "1:748412377392:web:918cc14cfcada4495fd0f5",
            measurementId: "G-C0Y0G7C63V"
        };

        const app = initializeApp(userFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // Use global variables provided by environment if available, otherwise default (Logic for Artifacts)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fintrack-prod';
        
        // --- State Management ---
        let currentUser = null;
        let state = {
            bills: [],
            ledger: [],
            manualExpenses: [],
            settings: { income: 0, day1: 15, day2: 30 } // Defaults
        };
        let unsubscribers = [];

        // --- Auth Logic ---
        const provider = new GoogleAuthProvider();
        const loginScreen = document.getElementById('login-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app-container');
        const authSection = document.getElementById('auth-section');

        // Init Auth Flow
        const initAuth = async () => {
             // System Prompt Requirement: Try Custom Token First (for Preview Environment)
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (e) {
                    console.warn("Custom token failed, falling back to UI", e);
                }
            }
            
            // Auth Listener
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    updateAuthUI(user);
                    initDataListeners(user.uid);
                } else {
                    loadingScreen.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    authSection.innerHTML = '';
                    cleanupListeners();
                }
            });
        };

        initAuth();

        document.getElementById('btn-google-login').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Login Failed:", error);
                alert(`Login failed: ${error.message}. If you are in the preview environment, this is expected due to domain restrictions. Deployment to GitHub will work.`);
                // Fallback for Preview ONLY if Google fails
                if(window.location.hostname.includes("googleusercontent")) {
                     signInAnonymously(auth);
                }
            });
        });

        function updateAuthUI(user) {
            authSection.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=User'}" class="w-8 h-8 rounded-full border border-gray-700">
                    <span class="hidden md:inline text-sm font-medium text-gray-300">${user.displayName || 'User'}</span>
                    <button id="btn-logout" class="text-xs bg-gray-800 hover:bg-red-900/50 text-gray-400 hover:text-red-400 px-3 py-1.5 rounded-lg transition-colors ml-2">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    </button>
                </div>
            `;
            document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
        }

        // --- Data Listeners (Firestore) ---
        function initDataListeners(userId) {
            loadingScreen.classList.remove('hidden');
            
            // Paths based on System Instructions
            const billsRef = collection(db, 'artifacts', appId, 'users', userId, 'bills');
            const ledgerRef = collection(db, 'artifacts', appId, 'users', userId, 'ledger');
            const settingsRef = collection(db, 'artifacts', appId, 'users', userId, 'settings');

            // 1. Settings
            const unsubSettings = onSnapshot(settingsRef, (snapshot) => {
                if(!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    state.settings = { ...state.settings, ...data, id: snapshot.docs[0].id };
                }
                refreshUI();
            }, (err) => console.error(err));

            // 2. Bills
            const unsubBills = onSnapshot(billsRef, (snapshot) => {
                state.bills = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                refreshUI();
            }, (err) => console.error(err));

            // 3. Ledger (Transactions)
            const unsubLedger = onSnapshot(ledgerRef, (snapshot) => {
                state.ledger = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                state.manualExpenses = state.ledger.filter(l => l.type === 'manual');
                refreshUI();
                loadingScreen.classList.add('hidden');
            }, (err) => console.error(err));

            unsubscribers.push(unsubSettings, unsubBills, unsubLedger);
        }

        function cleanupListeners() {
            unsubscribers.forEach(u => u());
            unsubscribers = [];
        }

        // --- Core Logic & Rendering ---

        function refreshUI() {
            renderDashboard();
            renderBills();
            renderForecast();
        }

        // 1. Dashboard Logic
        window.renderDashboard = function() {
            const today = new Date();
            const currentMonthStr = today.toISOString().slice(0, 7); // YYYY-MM

            // Filter Ledger for current Month
            const monthTransactions = state.ledger.filter(t => t.date.startsWith(currentMonthStr));
            
            const incomeReceived = monthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const expensesPaid = monthTransactions
                .filter(t => (t.type === 'manual' || (t.type === 'bill' && t.isPaid)))
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            // Calculate Pending Bills
            const billsDue = state.bills.filter(b => {
                // Check if paid in ledger
                const isPaid = state.ledger.some(l => l.refId === b.id && l.date.startsWith(currentMonthStr) && l.isPaid);
                return !isPaid; // Simple logic: if not in ledger as paid, it's pending
            }).length;

            // Update Summary Cards
            document.getElementById('dash-net-cash').innerText = formatCurrency(incomeReceived - expensesPaid);
            document.getElementById('dash-total-paid').innerText = formatCurrency(expensesPaid);
            document.getElementById('dash-pending-bills').innerText = billsDue;

            // Render Manual Expenses List
            const listEl = document.getElementById('manual-expenses-list');
            const manualList = state.manualExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(manualList.length === 0) {
                listEl.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-600">No manual expenses recorded.</td></tr>`;
            } else {
                listEl.innerHTML = manualList.map(ex => `
                    <tr class="hover:bg-gray-900/50 transition-colors group">
                        <td class="px-4 py-3 font-mono text-xs text-gray-500">${ex.date}</td>
                        <td class="px-4 py-3 text-white">${ex.description}</td>
                        <td class="px-4 py-3 text-right font-medium text-red-400">-${formatCurrency(ex.amount)}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="deleteTransaction('${ex.id}')" class="text-gray-600 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // 2. Bills Logic
        window.renderBills = function() {
            const listEl = document.getElementById('bills-list');
            if (state.bills.length === 0) {
                listEl.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500 border border-dashed border-gray-800 rounded-xl">No recurring bills set up yet.</div>`;
                return;
            }

            listEl.innerHTML = state.bills.map(bill => `
                <div class="glass-panel p-5 rounded-xl border border-gray-800 flex justify-between items-start group hover:border-gray-700 transition-colors">
                    <div>
                        <h4 class="font-bold text-white text-lg">${bill.name}</h4>
                        <div class="flex items-center gap-3 mt-2">
                            <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded uppercase font-medium tracking-wider">${bill.frequency}</span>
                            <span class="text-xs text-gray-500"><i class="fa-regular fa-calendar mr-1"></i> Due day: ${bill.dueDay}</span>
                        </div>
                        ${bill.endDate ? `<p class="text-xs text-orange-400 mt-2">Ends: ${bill.endDate}</p>` : ''}
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-gray-200">${formatCurrency(bill.amount)}</p>
                        <button onclick="editBill('${bill.id}')" class="mt-2 text-xs text-brand-500 hover:text-brand-400 opacity-0 group-hover:opacity-100 transition-opacity">Edit</button>
                    </div>
                </div>
            `).join('');
        }

        // 3. Forecast Logic (The Complex Part)
        window.renderForecast = function() {
            const container = document.getElementById('forecast-container');
            container.innerHTML = '';
            
            const months = getNext3Months();
            const payoutPerCycle = state.settings.income / 2;

            months.forEach(monthObj => {
                const monthStr = monthObj.iso; // YYYY-MM
                const monthName = monthObj.label;

                // Generate Forecast Items
                let items = [];

                // A. Income (2 Payouts)
                [state.settings.day1, state.settings.day2].forEach((day, idx) => {
                    const idBase = `income_${monthStr}_${idx}`;
                    // Check Ledger
                    const existing = state.ledger.find(l => l.refId === idBase && l.type === 'income');
                    const isReceived = !!existing;
                    const amt = isReceived ? existing.amount : payoutPerCycle;

                    items.push({
                        id: idBase,
                        type: 'income',
                        title: `Payout #${idx + 1}`,
                        amount: amt,
                        day: day,
                        date: `${monthStr}-${String(day).padStart(2,'0')}`,
                        isCompleted: isReceived,
                        status: isReceived ? 'Received' : 'Pending'
                    });
                });

                // B. Bills
                state.bills.forEach(bill => {
                    // Check termination
                    if (bill.endDate && new Date(bill.endDate) < new Date(`${monthStr}-01`)) return;

                    const idBase = `bill_${bill.id}_${monthStr}`;
                    // Check Ledger
                    const existing = state.ledger.find(l => l.refId === bill.id && l.date.startsWith(monthStr) && l.isPaid);
                    const isPaid = !!existing;
                    const amt = isPaid ? existing.amount : bill.amount;

                    items.push({
                        id: idBase, // Virtual ID
                        realId: bill.id, // Real Bill ID
                        type: 'bill',
                        title: bill.name,
                        amount: amt,
                        day: bill.dueDay,
                        date: `${monthStr}-${String(bill.dueDay).padStart(2,'0')}`,
                        isCompleted: isPaid,
                        status: isPaid ? 'Paid' : 'Due'
                    });
                });

                // Sort by day
                items.sort((a, b) => a.day - b.day);

                // Calculate projected balance impact for this month (Simple View)
                const totalIn = items.filter(i => i.type === 'income').reduce((s, i) => s + parseFloat(i.amount), 0);
                const totalOut = items.filter(i => i.type === 'bill').reduce((s, i) => s + parseFloat(i.amount), 0);
                const net = totalIn - totalOut;

                // Render Card
                const html = `
                    <div class="glass-panel rounded-2xl border border-gray-800 flex flex-col h-full">
                        <div class="p-5 border-b border-gray-800 bg-gray-900/30">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-bold text-lg text-white">${monthName}</h4>
                                <span class="text-xs font-mono ${net >= 0 ? 'text-green-400' : 'text-red-400'}">${net >= 0 ? '+' : ''}${formatCurrency(net)}</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>In: ${formatCurrency(totalIn)}</span>
                                <span>Out: ${formatCurrency(totalOut)}</span>
                            </div>
                        </div>
                        <div class="flex-1 p-2 overflow-y-auto space-y-1 max-h-[400px]">
                            ${items.map(item => `
                                <div class="flex items-center justify-between p-3 rounded-lg ${item.isCompleted ? 'opacity-50 bg-gray-900' : 'bg-gray-800/50 hover:bg-gray-800'} transition-all cursor-pointer" onclick="triggerTransaction('${item.type}', '${item.realId || item.id}', '${item.date}', ${item.amount}, '${item.title}', ${item.isCompleted})">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full ${item.type === 'income' ? 'bg-green-500' : 'bg-red-500'}"></div>
                                        <div>
                                            <p class="text-sm font-medium text-gray-200">${item.title}</p>
                                            <p class="text-[10px] text-gray-500">${item.date} â€¢ ${item.status}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-sm font-medium ${item.type === 'income' ? 'text-green-400' : 'text-red-400'}">
                                            ${item.type === 'bill' ? '-' : ''}${formatCurrency(item.amount)}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- Transaction Handling (Mark as Paid/Received) ---
        window.triggerTransaction = function(type, refId, date, currentAmount, title, isCompleted) {
            if (isCompleted) {
                // Ideally allow editing completed, but for now let's toggle off or alert
                if(confirm("This item is already marked as complete. Do you want to un-mark it?")) {
                    // Find the ledger entry and delete it
                    const entry = state.ledger.find(l => 
                        (l.refId === refId && l.date === date) || 
                        (type === 'bill' && l.refId === refId && l.date.startsWith(date.slice(0,7)))
                    );
                    if(entry) deleteTransaction(entry.id);
                }
                return;
            }

            // Open Modal
            document.getElementById('trans-modal-title').innerText = type === 'income' ? 'Receive Income' : 'Pay Bill';
            document.getElementById('trans-modal-desc').innerText = `Confirming: ${title}`;
            document.getElementById('trans-type').value = type;
            document.getElementById('trans-ref-id').value = refId;
            document.getElementById('trans-date').value = date;
            document.getElementById('trans-amount').value = currentAmount;
            
            openModal('modal-transaction');
        }

        window.confirmTransaction = async function() {
            const type = document.getElementById('trans-type').value;
            const refId = document.getElementById('trans-ref-id').value;
            const date = document.getElementById('trans-date').value;
            const amount = parseFloat(document.getElementById('trans-amount').value);

            if (!amount) return alert("Enter valid amount");

            try {
                const payload = {
                    type: type, // 'income' or 'bill'
                    amount: amount,
                    date: date,
                    isPaid: true, // for bills
                    isReceived: true, // for income
                    refId: refId, // Links back to bill ID or income slot ID
                    createdAt: new Date().toISOString()
                };

                // Using addDoc since we might pay multiple times or want history
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'ledger'), payload);
                closeModal('modal-transaction');
            } catch (e) {
                console.error(e);
                alert("Error saving transaction");
            }
        }

        // --- CRUD Operations ---

        // Manual Expense
        window.openExpenseModal = () => openModal('modal-expense');
        
        window.saveExpense = async function() {
            const desc = document.getElementById('expense-desc').value;
            const amount = document.getElementById('expense-amount').value;
            const date = document.getElementById('expense-date').value || new Date().toISOString().split('T')[0];

            if (!desc || !amount) return alert("Please fill all fields");

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'ledger'), {
                    type: 'manual',
                    description: desc,
                    amount: parseFloat(amount),
                    date: date,
                    createdAt: new Date().toISOString()
                });
                closeModal('modal-expense');
                document.getElementById('expense-desc').value = '';
                document.getElementById('expense-amount').value = '';
            } catch (e) {
                console.error(e);
                alert("Error saving expense");
            }
        }

        window.deleteTransaction = async function(id) {
            if(!confirm("Delete this record?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'ledger', id));
        }

        // Bills
        window.openBillModal = () => {
            document.getElementById('bill-id').value = '';
            document.getElementById('bill-name').value = '';
            document.getElementById('bill-amount').value = '';
            document.getElementById('bill-day').value = '';
            document.getElementById('bill-end-date').value = '';
            document.getElementById('btn-delete-bill').classList.add('hidden');
            openModal('modal-bill');
        }

        window.editBill = (id) => {
            const bill = state.bills.find(b => b.id === id);
            if(!bill) return;
            document.getElementById('bill-id').value = bill.id;
            document.getElementById('bill-name').value = bill.name;
            document.getElementById('bill-amount').value = bill.amount;
            document.getElementById('bill-day').value = bill.dueDay;
            document.getElementById('bill-end-date').value = bill.endDate || '';
            document.getElementById('btn-delete-bill').classList.remove('hidden');
            openModal('modal-bill');
        }

        window.saveBill = async function() {
            const id = document.getElementById('bill-id').value;
            const data = {
                name: document.getElementById('bill-name').value,
                amount: parseFloat(document.getElementById('bill-amount').value),
                dueDay: parseInt(document.getElementById('bill-day').value),
                endDate: document.getElementById('bill-end-date').value,
                frequency: document.getElementById('bill-freq').value
            };

            if (!data.name || !data.amount || !data.dueDay) return alert("Fill required fields");

            const ref = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'bills');
            try {
                if(id) {
                    await setDoc(doc(ref, id), data, { merge: true });
                } else {
                    await addDoc(ref, data);
                }
                closeModal('modal-bill');
            } catch (e) { console.error(e); alert("Error saving bill"); }
        }

        window.deleteBill = async function() {
            const id = document.getElementById('bill-id').value;
            if(!id || !confirm("Delete this recurring bill?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'bills', id));
            closeModal('modal-bill');
        }

        // Settings
        window.openSettingsModal = () => {
            document.getElementById('setting-income').value = state.settings.income;
            document.getElementById('setting-day1').value = state.settings.day1;
            document.getElementById('setting-day2').value = state.settings.day2;
            openModal('modal-settings');
        }

        window.saveSettings = async function() {
            const data = {
                income: parseFloat(document.getElementById('setting-income').value) || 0,
                day1: parseInt(document.getElementById('setting-day1').value) || 15,
                day2: parseInt(document.getElementById('setting-day2').value) || 30
            };

            const ref = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'settings');
            try {
                // Assume single settings doc or overwrite with fixed ID if preferred. using add/update logic
                if(state.settings.id) {
                    await setDoc(doc(ref, state.settings.id), data, { merge: true });
                } else {
                    await addDoc(ref, data);
                }
                closeModal('modal-settings');
            } catch(e) { console.error(e); }
        }


        // --- Utilities ---

        window.switchTab = function(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            // Update Tab styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-brand-500', 'bg-gray-800', 'shadow-sm');
                btn.classList.add('text-gray-400');
            });
            const activeBtn = document.getElementById(`tab-${tabId}`);
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('text-brand-500', 'bg-gray-800', 'shadow-sm');
            
            if(tabId === 'forecast') renderForecast();
        }

        window.openModal = (id) => {
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            el.classList.add('flex');
        }
        window.closeModal = (id) => {
            const el = document.getElementById(id);
            el.classList.add('hidden');
            el.classList.remove('flex');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        function getNext3Months() {
            const result = [];
            const today = new Date();
            // Adjust date to 1st to avoid end-of-month skipping issues
            let current = new Date(today.getFullYear(), today.getMonth(), 1);

            for(let i=0; i<3; i++) {
                const iso = current.toISOString().slice(0, 7);
                const label = current.toLocaleString('default', { month: 'long', year: 'numeric' });
                result.push({ iso, label });
                current.setMonth(current.getMonth() + 1);
            }
            return result;
        }

        // --- Init ---
        window.switchTab('dashboard');

    </script>
</body>
</html>
