<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack - Personal Finance Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#0b0f19',
                        },
                        brand: {
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-gray-900/80 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-brand-500/20">
                        <i class="fa-solid fa-wallet text-white text-sm"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight">FinTrack</span>
                </div>
                <div id="auth-section" class="flex items-center gap-4">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 hidden">
        
        <!-- Tabs -->
        <div class="flex space-x-1 bg-gray-900/50 p-1 rounded-xl mb-8 w-full max-w-md mx-auto border border-gray-800">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all duration-200 text-brand-500 bg-gray-800 shadow-sm">Dashboard</button>
            <button onclick="switchTab('bills')" id="tab-bills" class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-gray-200 transition-all duration-200">Recurring Bills</button>
            <button onclick="switchTab('forecast')" id="tab-forecast" class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 hover:text-gray-200 transition-all duration-200">Forecast</button>
        </div>

        <!-- View: Dashboard -->
        <div id="view-dashboard" class="view-section space-y-6 animate-fade-in">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-sack-dollar text-4xl text-green-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">Net Cash (This Month)</p>
                    <h3 class="text-3xl font-bold text-white mt-2" id="dash-net-cash">₱0.00</h3>
                    <p class="text-xs text-gray-500 mt-2">Income Received - Expenses Paid</p>
                </div>

                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-arrow-trend-down text-4xl text-red-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">Total Expenses Paid</p>
                    <h3 class="text-3xl font-bold text-white mt-2" id="dash-total-paid">₱0.00</h3>
                    <p class="text-xs text-gray-500 mt-2">Includes Bills & Manual</p>
                </div>
                
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="fa-solid fa-clock text-4xl text-yellow-400"></i>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">Pending Bills</p>
                    <h3 class="text-3xl font-bold text-white mt-2" id="dash-pending-bills">0</h3>
                    <p class="text-xs text-gray-500 mt-2">Due this month</p>
                </div>
            </div>

            <!-- Transaction History (Manual + Bills) -->
            <div class="glass-panel rounded-2xl border border-gray-800 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-gray-400"></i> Monthly Payment History
                    </h2>
                    <button onclick="openExpenseModal()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm transition-colors border border-gray-700 flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Add Manual Expense
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-900/50 uppercase text-xs font-semibold text-gray-500">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">Payment Date</th>
                                <th class="px-4 py-3">Type</th>
                                <th class="px-4 py-3">Description</th>
                                <th class="px-4 py-3 text-right">Amount</th>
                                <th class="px-4 py-3 text-center rounded-r-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-history-list" class="divide-y divide-gray-800">
                            <!-- Populated by JS -->
                            <tr><td colspan="5" class="text-center py-4 text-gray-600">Loading transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- View: Recurring Bills -->
        <div id="view-bills" class="view-section hidden space-y-6">
            <div class="flex justify-between items-center">
                <div class="space-y-1">
                    <h2 class="text-2xl font-bold">Recurring Bills</h2>
                    <p class="text-gray-400 text-sm">Manage monthly, semi-monthly, or one-time obligations.</p>
                </div>
                <button onclick="openBillModal()" class="bg-brand-600 hover:bg-brand-500 text-white px-5 py-2.5 rounded-lg font-medium shadow-lg shadow-brand-500/20 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Add Bill
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="bills-list">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- View: Forecast -->
        <div id="view-forecast" class="view-section hidden space-y-6">
            <div class="glass-panel p-4 rounded-xl flex flex-col md:flex-row justify-between items-center gap-4 border border-gray-800">
                <div class="flex items-center gap-3">
                    <div class="p-3 bg-gray-800 rounded-lg text-brand-400">
                        <i class="fa-solid fa-sliders"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">Budget Settings</h3>
                        <p class="text-xs text-gray-400">Net Monthly Income & Payout Dates</p>
                    </div>
                </div>
                <button onclick="openSettingsModal()" class="text-sm bg-gray-800 hover:bg-gray-700 border border-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Edit Settings
                </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6" id="forecast-container">
                <!-- 3 Month Columns Injected Here -->
            </div>
        </div>

    </main>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-950 flex items-center justify-center z-40">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-brand-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <h2 class="text-xl font-semibold text-white">FinTrack</h2>
            <p class="text-gray-500 text-sm mt-2">Loading your finances...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-950 flex items-center justify-center z-50 hidden">
        <div class="glass-panel p-8 rounded-2xl max-w-md w-full mx-4 text-center border border-gray-800 shadow-2xl">
            <div class="w-16 h-16 bg-brand-900/30 rounded-2xl flex items-center justify-center mx-auto mb-6 text-brand-500">
                <i class="fa-solid fa-wallet text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">Welcome Back</h1>
            <p class="text-gray-400 mb-8">Sign in to access your personal financial tracker and budget forecast.</p>
            
            <button id="btn-google-login" class="w-full bg-white text-gray-900 hover:bg-gray-100 font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-3 group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                <span>Continue with Google</span>
            </button>
            <p class="text-xs text-gray-600 mt-6">Secure authentication powered by Firebase</p>
        </div>
    </div>

    <!-- MODAL: Add/Edit Manual Expense -->
    <div id="modal-expense" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl transform transition-all">
            <h3 class="text-xl font-bold mb-4 text-white">Expense Details</h3>
            <input type="hidden" id="expense-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Description</label>
                    <input type="text" id="expense-desc" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="e.g. Grocery run">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Amount</label>
                        <input type="number" id="expense-amount" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Date</label>
                        <input type="date" id="expense-date" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('modal-expense')" class="flex-1 py-2.5 rounded-lg text-gray-300 hover:bg-gray-800 transition-colors">Cancel</button>
                <button onclick="saveExpense()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white font-medium py-2.5 rounded-lg transition-colors shadow-lg shadow-brand-600/20">Save</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Add/Edit Recurring Bill -->
    <div id="modal-bill" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-md shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Recurring Bill</h3>
                <button id="btn-delete-bill" onclick="deleteBill()" class="text-red-400 text-xs hover:underline hidden">Delete</button>
            </div>
            <input type="hidden" id="bill-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Bill Name</label>
                    <input type="text" id="bill-name" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="e.g. Internet">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Amount (Est.)</label>
                        <input type="number" id="bill-amount" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Frequency</label>
                        <select id="bill-freq" onchange="toggleBillFields()" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                            <option value="monthly">Monthly</option>
                            <option value="semi-monthly">Semi-Monthly</option>
                            <option value="one-time">One-Time</option>
                        </select>
                    </div>
                </div>
                
                <!-- Due Dates -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1" id="lbl-due-1">Day of Month Due</label>
                        <input type="number" id="bill-day" min="1" max="31" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="1-31">
                    </div>
                    <div id="field-due-2" class="hidden">
                        <label class="block text-xs font-medium text-gray-400 mb-1">2nd Due Day</label>
                        <input type="number" id="bill-day-2" min="1" max="31" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none" placeholder="1-31">
                    </div>
                </div>

                <!-- Dates -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Start Date (for counting)</label>
                        <input type="date" id="bill-start-date" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">Termination (Optional)</label>
                        <input type="date" id="bill-end-date" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('modal-bill')" class="flex-1 py-2.5 rounded-lg text-gray-300 hover:bg-gray-800 transition-colors">Cancel</button>
                <button onclick="saveBill()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white font-medium py-2.5 rounded-lg transition-colors shadow-lg shadow-brand-600/20">Save Bill</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Settings (Income/Payout) -->
    <div id="modal-settings" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-white">Budget Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Total Net Monthly Income</label>
                    <input type="number" id="setting-income" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                </div>
                <div class="bg-gray-800/50 p-3 rounded-lg text-xs text-gray-400">
                    Income is split into two payouts (Semi-monthly).
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">1st Payout Day</label>
                        <input type="number" id="setting-day1" min="1" max="31" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400 mb-1">2nd Payout Day</label>
                        <input type="number" id="setting-day2" min="1" max="31" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('modal-settings')" class="flex-1 py-2.5 rounded-lg text-gray-300 hover:bg-gray-800 transition-colors">Cancel</button>
                <button onclick="saveSettings()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white font-medium py-2.5 rounded-lg transition-colors">Save</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Edit Actual Payout / Bill Payment -->
    <div id="modal-transaction" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-2 text-white" id="trans-modal-title">Confirm Transaction</h3>
            <p class="text-sm text-gray-400 mb-4" id="trans-modal-desc">Adjust the actual amount if different from projected.</p>
            
            <input type="hidden" id="trans-ref-id">
            <input type="hidden" id="trans-type"> <!-- 'income' or 'bill' -->
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Actual Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500">₱</span>
                        <input type="number" id="trans-amount" step="0.01" class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-8 pr-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Date Paid / Received</label>
                    <input type="date" id="trans-date" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2.5 text-white focus:ring-2 focus:ring-brand-600 outline-none">
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal('modal-transaction')" class="flex-1 py-2.5 rounded-lg text-gray-300 hover:bg-gray-800 transition-colors">Cancel</button>
                <button onclick="confirmTransaction()" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-medium py-2.5 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyCWr-FADGeiUDxNokX0fdLubp-mnPZMhOM",
            authDomain: "fintrack-42a39.firebaseapp.com",
            databaseURL: "https://fintrack-42a39-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fintrack-42a39",
            storageBucket: "fintrack-42a39.firebasestorage.app",
            messagingSenderId: "748412377392",
            appId: "1:748412377392:web:918cc14cfcada4495fd0f5",
            measurementId: "G-C0Y0G7C63V"
        };

        const app = initializeApp(userFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fintrack-prod';
        
        // --- State Management ---
        let currentUser = null;
        let state = {
            bills: [],
            ledger: [],
            manualExpenses: [],
            settings: { income: 0, day1: 15, day2: 30 }
        };
        let unsubscribers = [];

        // --- Auth Logic ---
        const provider = new GoogleAuthProvider();
        const loginScreen = document.getElementById('login-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app-container');
        const authSection = document.getElementById('auth-section');

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { console.warn(e); }
            }
            
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    updateAuthUI(user);
                    initDataListeners(user.uid);
                } else {
                    loadingScreen.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    authSection.innerHTML = '';
                    cleanupListeners();
                }
            });
        };

        initAuth();

        document.getElementById('btn-google-login').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Login Failed:", error);
                if(window.location.hostname.includes("googleusercontent")) signInAnonymously(auth);
            });
        });

        function updateAuthUI(user) {
            authSection.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=User'}" class="w-8 h-8 rounded-full border border-gray-700">
                    <span class="hidden md:inline text-sm font-medium text-gray-300">${user.displayName || 'User'}</span>
                    <button id="btn-logout" class="text-xs bg-gray-800 hover:bg-red-900/50 text-gray-400 hover:text-red-400 px-3 py-1.5 rounded-lg transition-colors ml-2">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    </button>
                </div>
            `;
            document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
        }

        // --- Data Listeners ---
        function initDataListeners(userId) {
            loadingScreen.classList.remove('hidden');
            
            const billsRef = collection(db, 'artifacts', appId, 'users', userId, 'bills');
            const ledgerRef = collection(db, 'artifacts', appId, 'users', userId, 'ledger');
            const settingsRef = collection(db, 'artifacts', appId, 'users', userId, 'settings');

            const unsubSettings = onSnapshot(settingsRef, (snapshot) => {
                if(!snapshot.empty) {
                    const data = snapshot.docs[0].data();
                    state.settings = { ...state.settings, ...data, id: snapshot.docs[0].id };
                }
                refreshUI();
            });

            const unsubBills = onSnapshot(billsRef, (snapshot) => {
                state.bills = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                refreshUI();
            });

            const unsubLedger = onSnapshot(ledgerRef, (snapshot) => {
                state.ledger = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                state.manualExpenses = state.ledger.filter(l => l.type === 'manual');
                refreshUI();
                loadingScreen.classList.add('hidden');
            });

            unsubscribers.push(unsubSettings, unsubBills, unsubLedger);
        }

        function cleanupListeners() {
            unsubscribers.forEach(u => u());
            unsubscribers = [];
        }

        // --- Core Logic ---

        function refreshUI() {
            renderDashboard();
            renderBills();
            renderForecast();
        }

        // 1. Dashboard: Merged History
        window.renderDashboard = function() {
            const today = new Date();
            const currentMonthStr = today.toISOString().slice(0, 7); 

            const monthTransactions = state.ledger.filter(t => t.date.startsWith(currentMonthStr));
            
            const incomeReceived = monthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const expensesPaid = monthTransactions
                .filter(t => t.type === 'manual' || t.type === 'bill')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const billsDue = state.bills.filter(b => {
                if(b.frequency === 'one-time') {
                    if (!b.dueDayFull || !b.dueDayFull.startsWith(currentMonthStr)) return false;
                    return !state.ledger.some(l => l.refId === b.id && l.isPaid);
                }
                const paymentsThisMonth = state.ledger.filter(l => l.refId === b.id && l.date.startsWith(currentMonthStr) && l.isPaid).length;
                const required = b.frequency === 'semi-monthly' ? 2 : 1;
                return paymentsThisMonth < required;
            }).length;

            document.getElementById('dash-net-cash').innerText = formatCurrency(incomeReceived - expensesPaid);
            document.getElementById('dash-total-paid').innerText = formatCurrency(expensesPaid);
            document.getElementById('dash-pending-bills').innerText = billsDue;

            const listEl = document.getElementById('dashboard-history-list');
            const historyList = monthTransactions
                .filter(t => t.type === 'manual' || t.type === 'bill')
                .sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(historyList.length === 0) {
                listEl.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-600">No payments made this month.</td></tr>`;
            } else {
                listEl.innerHTML = historyList.map(tx => {
                    const isBill = tx.type === 'bill';
                    return `
                    <tr class="hover:bg-gray-900/50 transition-colors group">
                        <td class="px-4 py-3 font-mono text-xs text-gray-500">${tx.date}</td>
                        <td class="px-4 py-3">
                            <span class="text-[10px] uppercase tracking-wider px-2 py-1 rounded ${isBill ? 'bg-indigo-900/30 text-indigo-400' : 'bg-orange-900/30 text-orange-400'}">
                                ${isBill ? 'Bill' : 'Manual'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-white text-sm">${tx.description || (isBill ? 'Recurring Bill' : 'Expense')}</td>
                        <td class="px-4 py-3 text-right font-medium text-red-400">-${formatCurrency(tx.amount)}</td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                ${!isBill ? `
                                <button onclick="editTransaction('${tx.id}')" class="text-gray-500 hover:text-brand-400">
                                    <i class="fa-solid fa-pen"></i>
                                </button>` : ''}
                                <button onclick="deleteTransaction('${tx.id}')" class="text-gray-500 hover:text-red-500">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `}).join('');
            }
        }

        // 2. Bills Logic (With X of Y and Semi-Monthly)
        window.renderBills = function() {
            const listEl = document.getElementById('bills-list');
            if (state.bills.length === 0) {
                listEl.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500 border border-dashed border-gray-800 rounded-xl">No recurring bills set up yet.</div>`;
                return;
            }

            const today = new Date();
            const currentMonthStr = today.toISOString().slice(0, 7); 

            listEl.innerHTML = state.bills.map(bill => {
                if(bill.frequency === 'one-time') {
                   if(bill.endDate && new Date(bill.endDate) < new Date(currentMonthStr + '-01')) return ''; 
                }

                // Payment Counter Logic (Enhanced)
                let counterStr = 'Payment Counter not started';
                if (bill.frequency !== 'one-time' && bill.startDate) {
                    const start = new Date(bill.startDate);
                    const now = new Date();
                    
                    // Calculate total months passed since start
                    const monthsPassed = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
                    
                    let currentTerm = monthsPassed + 1; 
                    if (currentTerm < 1) currentTerm = 1; 

                    if (bill.frequency === 'semi-monthly') {
                        counterStr = `Month #${currentTerm}`;
                    } else {
                        counterStr = `Payment #${currentTerm}`;
                    }
                    
                    // Append Total if End Date exists
                    if(bill.endDate) {
                         const end = new Date(bill.endDate);
                         const totalMonths = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
                         counterStr += ` of ${totalMonths}`;
                     }
                } else if (bill.frequency === 'one-time') {
                    counterStr = "Single Payment";
                }

                // Render Actions
                let actionsHtml = '';
                
                if (bill.frequency === 'semi-monthly') {
                    // Two due dates
                    // Need to handle if paid on ANY date in this month that matches refId
                    // For matching, we check if we have 2 entries? Or match specifically close to due date?
                    // To allow "Choose Date", we check how many times paid this month
                    const paymentsThisMonth = state.ledger.filter(l => l.refId === bill.id && l.date.startsWith(currentMonthStr) && l.isPaid);
                    
                    // Sort payments by date
                    paymentsThisMonth.sort((a,b) => new Date(a.date) - new Date(b.date));
                    
                    const paid1 = paymentsThisMonth.length > 0 ? paymentsThisMonth[0] : null;
                    const paid2 = paymentsThisMonth.length > 1 ? paymentsThisMonth[1] : null;

                    // Default Default dates for the picker (Due dates)
                    const defaultDate1 = `${currentMonthStr}-${String(bill.dueDay).padStart(2,'0')}`;
                    const defaultDate2 = `${currentMonthStr}-${String(bill.dueDay2).padStart(2,'0')}`;

                    actionsHtml = `
                        <div class="grid grid-cols-2 gap-2 mt-4">
                            ${renderBillBtn(bill, defaultDate1, paid1, '1st')}
                            ${renderBillBtn(bill, defaultDate2, paid2, '2nd')}
                        </div>
                    `;
                } else if (bill.frequency === 'one-time') {
                     const date = `${currentMonthStr}-${String(bill.dueDay).padStart(2,'0')}`;
                     const paid = state.ledger.find(l => l.refId === bill.id && l.isPaid); 
                     actionsHtml = `<div class="mt-4">${renderBillBtn(bill, date, paid, 'Pay')}</div>`;
                } else {
                    // Monthly
                    const defaultDate = `${currentMonthStr}-${String(bill.dueDay).padStart(2,'0')}`;
                    // Find if paid this month
                    const paid = state.ledger.find(l => l.refId === bill.id && l.date.startsWith(currentMonthStr) && l.isPaid);
                    actionsHtml = `<div class="mt-4">${renderBillBtn(bill, defaultDate, paid, 'Pay')}</div>`;
                }

                return `
                <div class="glass-panel p-5 rounded-xl border border-gray-800 flex flex-col relative group">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-white text-lg">${bill.name}</h4>
                            <div class="flex items-center gap-2 mt-1 text-xs text-gray-400">
                                <span class="bg-gray-800 px-2 py-0.5 rounded uppercase">${bill.frequency}</span>
                            </div>
                            <div class="mt-2 text-sm font-medium text-brand-400 bg-brand-900/20 px-2 py-1 rounded inline-block border border-brand-500/20">
                                <i class="fa-solid fa-hashtag text-[10px] mr-1"></i> ${counterStr}
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                Due: ${bill.dueDay}${bill.dueDay2 ? ' & '+bill.dueDay2 : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold text-gray-200">${formatCurrency(bill.amount)}</p>
                            <button onclick="editBill('${bill.id}')" class="mt-2 text-xs text-brand-500 hover:text-brand-400 opacity-0 group-hover:opacity-100 transition-opacity">Edit</button>
                        </div>
                    </div>
                    ${actionsHtml}
                </div>
                `;
            }).join('');
        }

        function renderBillBtn(bill, defaultDateStr, paidEntry, label) {
            const isPaid = !!paidEntry;
            // If paid, show the ACTUAL date paid
            const displayDate = isPaid ? paidEntry.date : defaultDateStr;
            
            return `
                <button 
                    onclick="triggerTransaction('bill', '${bill.id}', '${displayDate}', ${bill.amount}, '${bill.name} (${label})', ${isPaid}, '${paidEntry ? paidEntry.id : ''}')"
                    class="w-full py-2 rounded-lg text-xs font-medium transition-all flex items-center justify-center gap-2
                    ${isPaid 
                        ? 'bg-green-900/20 text-green-400 border border-green-900/50' 
                        : 'bg-gray-800 hover:bg-gray-700 text-white border border-gray-700'}"
                >
                    ${isPaid ? `<div class='flex flex-col items-start'><span class='font-bold'><i class="fa-solid fa-check"></i> Paid</span><span class='text-[10px] opacity-75'>${displayDate}</span></div>` : `Mark ${label} Due`}
                </button>
            `;
        }

        // 3. Forecast Logic
        window.renderForecast = function() {
            const container = document.getElementById('forecast-container');
            container.innerHTML = '';
            
            const months = getNext3Months();
            const payoutPerCycle = state.settings.income / 2;

            months.forEach(monthObj => {
                const monthStr = monthObj.iso; // YYYY-MM
                let items = [];

                // A. Income
                [state.settings.day1, state.settings.day2].forEach((day, idx) => {
                    const idBase = `income_${monthStr}_${idx}`;
                    const existing = state.ledger.find(l => l.refId === idBase && l.type === 'income');
                    items.push({
                        id: idBase, type: 'income', title: `Payout #${idx + 1}`,
                        amount: existing ? existing.amount : payoutPerCycle,
                        day: day, date: `${monthStr}-${String(day).padStart(2,'0')}`,
                        isCompleted: !!existing, status: existing ? 'Received' : 'Pending'
                    });
                });

                // B. Bills
                state.bills.forEach(bill => {
                    if (bill.endDate && new Date(bill.endDate) < new Date(`${monthStr}-01`)) return;
                    if (bill.startDate && new Date(bill.startDate) > new Date(`${monthStr}-28`)) return;

                    if (bill.frequency === 'semi-monthly') {
                        [bill.dueDay, bill.dueDay2].forEach(day => {
                            if(!day) return;
                            const dateStr = `${monthStr}-${String(day).padStart(2,'0')}`;
                            // Imprecise match for forecast check
                            const paid = state.ledger.find(l => l.refId === bill.id && l.date.startsWith(monthStr));
                            items.push(createForecastItem(bill, day, dateStr, paid));
                        });
                    } else if (bill.frequency === 'one-time') {
                        if (bill.startDate && bill.startDate.startsWith(monthStr)) {
                             const day = parseInt(bill.startDate.split('-')[2]);
                             const paid = state.ledger.find(l => l.refId === bill.id && l.isPaid);
                             items.push(createForecastItem(bill, day, bill.startDate, paid));
                        }
                    } else {
                        const dateStr = `${monthStr}-${String(bill.dueDay).padStart(2,'0')}`;
                        const paid = state.ledger.find(l => l.refId === bill.id && l.date.startsWith(monthStr));
                        items.push(createForecastItem(bill, bill.dueDay, dateStr, paid));
                    }
                });

                items.sort((a, b) => a.day - b.day);
                
                const totalIn = items.filter(i => i.type === 'income').reduce((s, i) => s + parseFloat(i.amount), 0);
                const totalOut = items.filter(i => i.type === 'bill').reduce((s, i) => s + parseFloat(i.amount), 0);

                container.innerHTML += `
                    <div class="glass-panel rounded-2xl border border-gray-800 flex flex-col h-full">
                        <div class="p-5 border-b border-gray-800 bg-gray-900/30">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-bold text-lg text-white">${monthObj.label}</h4>
                                <span class="text-xs font-mono ${(totalIn-totalOut) >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(totalIn - totalOut)}</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>In: ${formatCurrency(totalIn)}</span>
                                <span>Out: ${formatCurrency(totalOut)}</span>
                            </div>
                        </div>
                        <div class="flex-1 p-2 overflow-y-auto space-y-1 max-h-[400px]">
                            ${items.map(item => `
                                <div class="flex items-center justify-between p-3 rounded-lg ${item.isCompleted ? 'opacity-50 bg-gray-900' : 'bg-gray-800/50 hover:bg-gray-800'} transition-all cursor-pointer" onclick="triggerTransaction('${item.type}', '${item.realId || item.id}', '${item.date}', ${item.amount}, '${item.title}', ${item.isCompleted}, '')">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full ${item.type === 'income' ? 'bg-green-500' : 'bg-red-500'}"></div>
                                        <div class="truncate max-w-[120px]">
                                            <p class="text-sm font-medium text-gray-200 truncate">${item.title}</p>
                                            <p class="text-[10px] text-gray-500">${item.date.slice(5)}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="block text-sm font-medium ${item.type === 'income' ? 'text-green-400' : 'text-red-400'}">
                                            ${item.type === 'bill' ? '-' : ''}${formatCurrency(item.amount)}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
        }

        function createForecastItem(bill, day, dateStr, paidEntry) {
            return {
                id: `bill_${bill.id}_${dateStr}`,
                realId: bill.id,
                type: 'bill',
                title: bill.name,
                amount: paidEntry ? paidEntry.amount : bill.amount,
                day: parseInt(day),
                date: dateStr,
                isCompleted: !!paidEntry,
                status: paidEntry ? 'Paid' : 'Due'
            };
        }

        // --- Transaction & Modals ---

        window.triggerTransaction = function(type, refId, defaultDate, currentAmount, title, isCompleted, ledgerId) {
            if (isCompleted) {
                if(confirm("Un-mark this transaction? It will be removed from history.")) {
                    // If we have the direct ledger ID, use it. Otherwise search.
                    if(ledgerId) {
                         deleteTransaction(ledgerId);
                    } else {
                        // Fallback for forecast items or loose matches
                        const entry = state.ledger.find(l => l.refId === refId && l.date === defaultDate);
                        if(entry) deleteTransaction(entry.id);
                    }
                }
                return;
            }
            document.getElementById('trans-modal-title').innerText = type === 'income' ? 'Receive Income' : 'Pay Bill';
            document.getElementById('trans-modal-desc').innerText = `Confirming: ${title}`;
            document.getElementById('trans-type').value = type;
            document.getElementById('trans-ref-id').value = refId;
            document.getElementById('trans-date').value = defaultDate; // Pre-fill with due date, but editable
            document.getElementById('trans-amount').value = currentAmount;
            openModal('modal-transaction');
        }

        window.confirmTransaction = async function() {
            const amount = parseFloat(document.getElementById('trans-amount').value);
            const date = document.getElementById('trans-date').value;
            
            if (!amount || !date) return alert("Please check amount and date");
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'ledger'), {
                    type: document.getElementById('trans-type').value,
                    amount: amount,
                    date: date, // Save the user-selected date
                    isPaid: true,
                    description: document.getElementById('trans-modal-desc').innerText.replace('Confirming: ', ''),
                    refId: document.getElementById('trans-ref-id').value, 
                    createdAt: new Date().toISOString()
                });
                closeModal('modal-transaction');
            } catch (e) { alert("Error"); console.error(e); }
        }

        // Edit Unplanned
        window.editTransaction = function(id) {
            const tx = state.ledger.find(t => t.id === id);
            if(!tx || tx.type !== 'manual') return;
            
            document.getElementById('expense-id').value = tx.id;
            document.getElementById('expense-desc').value = tx.description;
            document.getElementById('expense-amount').value = tx.amount;
            document.getElementById('expense-date').value = tx.date;
            openModal('modal-expense');
        }

        window.saveExpense = async function() {
            const id = document.getElementById('expense-id').value;
            const data = {
                type: 'manual',
                description: document.getElementById('expense-desc').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                date: document.getElementById('expense-date').value || new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            };
            
            if (!data.description || !data.amount) return;

            const ref = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'ledger');
            try {
                if(id) {
                    await setDoc(doc(ref, id), data, { merge: true });
                } else {
                    await addDoc(ref, data);
                }
                closeModal('modal-expense');
            } catch (e) { console.error(e); }
        }

        // Bill Form
        window.toggleBillFields = function() {
            const freq = document.getElementById('bill-freq').value;
            const due2 = document.getElementById('field-due-2');
            const lbl1 = document.getElementById('lbl-due-1');
            
            if(freq === 'semi-monthly') {
                due2.classList.remove('hidden');
                lbl1.innerText = "1st Due Day";
            } else if (freq === 'one-time') {
                due2.classList.add('hidden');
                lbl1.innerText = "Due Day (Day of month)"; // or change input to full date
            } else {
                due2.classList.add('hidden');
                lbl1.innerText = "Day of Month Due";
            }
        }

        window.openBillModal = () => {
            document.getElementById('bill-id').value = '';
            document.getElementById('bill-name').value = '';
            document.getElementById('bill-amount').value = '';
            document.getElementById('bill-freq').value = 'monthly';
            document.getElementById('bill-day').value = '';
            document.getElementById('bill-day-2').value = '';
            document.getElementById('bill-start-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('bill-end-date').value = '';
            toggleBillFields();
            document.getElementById('btn-delete-bill').classList.add('hidden');
            openModal('modal-bill');
        }

        window.editBill = (id) => {
            const bill = state.bills.find(b => b.id === id);
            if(!bill) return;
            document.getElementById('bill-id').value = bill.id;
            document.getElementById('bill-name').value = bill.name;
            document.getElementById('bill-amount').value = bill.amount;
            document.getElementById('bill-freq').value = bill.frequency || 'monthly';
            toggleBillFields();
            document.getElementById('bill-day').value = bill.dueDay;
            document.getElementById('bill-day-2').value = bill.dueDay2 || '';
            document.getElementById('bill-start-date').value = bill.startDate || '';
            document.getElementById('bill-end-date').value = bill.endDate || '';
            document.getElementById('btn-delete-bill').classList.remove('hidden');
            openModal('modal-bill');
        }

        window.saveBill = async function() {
            const id = document.getElementById('bill-id').value;
            const data = {
                name: document.getElementById('bill-name').value,
                amount: parseFloat(document.getElementById('bill-amount').value),
                frequency: document.getElementById('bill-freq').value,
                dueDay: parseInt(document.getElementById('bill-day').value),
                dueDay2: parseInt(document.getElementById('bill-day-2').value) || null,
                startDate: document.getElementById('bill-start-date').value,
                endDate: document.getElementById('bill-end-date').value,
            };

            if (!data.name || !data.amount || !data.dueDay) return alert("Fill required");
            
            const ref = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'bills');
            try {
                if(id) await setDoc(doc(ref, id), data, { merge: true });
                else await addDoc(ref, data);
                closeModal('modal-bill');
            } catch (e) { console.error(e); }
        }

        // Shared
        window.deleteTransaction = async (id) => {
            if(confirm("Remove this?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'ledger', id));
        }
        window.deleteBill = async () => {
             if(confirm("Delete recurring bill?")) {
                 const id = document.getElementById('bill-id').value;
                 await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'bills', id));
                 closeModal('modal-bill');
             }
        }
        window.openExpenseModal = () => {
            document.getElementById('expense-id').value = '';
            document.getElementById('expense-desc').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            openModal('modal-expense');
        }
        window.openSettingsModal = () => {
            document.getElementById('setting-income').value = state.settings.income;
            document.getElementById('setting-day1').value = state.settings.day1;
            document.getElementById('setting-day2').value = state.settings.day2;
            openModal('modal-settings');
        }
        window.saveSettings = async () => {
            const data = {
                income: parseFloat(document.getElementById('setting-income').value) || 0,
                day1: parseInt(document.getElementById('setting-day1').value) || 15,
                day2: parseInt(document.getElementById('setting-day2').value) || 30
            };
            const ref = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'settings');
            if(state.settings.id) await setDoc(doc(ref, state.settings.id), data, { merge: true });
            else await addDoc(ref, data);
            closeModal('modal-settings');
        }

        // Utils
        window.switchTab = (tabId) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-brand-500', 'bg-gray-800', 'shadow-sm');
                btn.classList.add('text-gray-400');
            });
            const activeBtn = document.getElementById(`tab-${tabId}`);
            activeBtn.classList.remove('text-gray-400');
            activeBtn.classList.add('text-brand-500', 'bg-gray-800', 'shadow-sm');
            if(tabId === 'forecast') renderForecast();
        }
        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); }
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }
        function formatCurrency(amount) { return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount); }
        function getNext3Months() {
            const result = [];
            const today = new Date();
            let current = new Date(today.getFullYear(), today.getMonth(), 1);
            for(let i=0; i<3; i++) {
                const iso = current.toISOString().slice(0, 7);
                const label = current.toLocaleString('default', { month: 'long', year: 'numeric' });
                result.push({ iso, label });
                current.setMonth(current.getMonth() + 1);
            }
            return result;
        }

        window.switchTab('dashboard');
    </script>
</body>
</html>
