<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FinTrack AI</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            background: '#0f172a', // slate-900
            surface: '#1e293b', // slate-800
            primary: '#3b82f6', // blue-500
            secondary: '#64748b', // slate-500
            accent: '#8b5cf6', // violet-500
            success: '#22c55e', // green-500
            danger: '#ef4444', // red-500
          }
        }
      }
    }
  </script>

  <!-- Babel for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Import Map: Defines where to load modules from -->
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "react-router-dom": "https://esm.sh/react-router-dom@6.22.3?deps=react@18.3.1,react-dom@18.3.1",
    "recharts": "https://esm.sh/recharts@2.12.7?deps=react@18.3.1,react-dom@18.3.1",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.3.1",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    /* Loading Animation */
    .loader {
      border: 4px solid #1e293b;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-background text-white antialiased min-h-screen overflow-hidden">
  
  <!-- Loading State (Visible until React mounts) -->
  <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-background z-50">
    <div class="loader mb-4"></div>
    <h2 class="text-xl font-bold text-blue-500">FinTrack AI</h2>
    <p class="text-gray-500 text-sm mt-2">Loading modules...</p>
  </div>

  <!-- Error Display (Visible if crash) -->
  <div id="error-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-red-900/20 z-[60] hidden p-8 text-center">
    <h2 class="text-2xl font-bold text-red-500 mb-2">Application Error</h2>
    <p class="text-gray-300 mb-4">Something went wrong while loading the application.</p>
    <pre id="error-message" class="bg-black/50 p-4 rounded text-left text-red-300 text-xs overflow-auto max-w-full"></pre>
    <button onclick="window.location.reload()" class="mt-6 bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded">Reload Page</button>
  </div>

  <div id="root"></div>

  <!-- Global Error Handler -->
  <script>
    window.onerror = function(msg, url, line, col, error) {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('error-screen').style.display = 'flex';
      document.getElementById('error-message').textContent = `Error: ${msg}\nLine: ${line}\nFile: ${url}`;
      console.error(error);
    };
    // Catch unhandled promise rejections
    window.onunhandledrejection = function(event) {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('error-screen').style.display = 'flex';
      document.getElementById('error-message').textContent = `Promise Error: ${event.reason}`;
    };
  </script>

  <!-- Application Code -->
  <script type="text/babel" data-type="module">
    /***********************************************************
     * IMPORTS
     ***********************************************************/
    import React, { useState, useEffect, useMemo, createContext, useContext } from 'react';
    import { createRoot } from 'react-dom/client';
    import { HashRouter, Routes, Route, Link, Navigate, useLocation } from 'react-router-dom';
    import { 
      LayoutDashboard, Receipt, CalendarClock, LogOut, PieChart as IconPieChart, 
      Plus, Trash2, Edit2, Sparkles, Wallet, CheckCircle, AlertCircle, Settings, Save, Check 
    } from 'lucide-react';
    import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from 'recharts';
    import { initializeApp } from 'firebase/app';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut as firebaseSignOut, onAuthStateChanged } from 'firebase/auth';
    import { getDatabase, ref, set, push, onValue, remove, update } from 'firebase/database';
    import { GoogleGenAI } from '@google/genai';

    // Hide loader once script starts executing (though React mount will be the real finish)
    // We'll hide it inside the root render
    
    /***********************************************************
     * CONFIGURATION & TYPES
     ***********************************************************/
    
    // Fake process.env for GenAI SDK if needed, though we usually pass apiKey in constructor
    window.process = { env: { API_KEY: '' } }; 

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCWr-FADGeiUDxNokX0fdLubp-mnPZMhOM",
      authDomain: "fintrack-42a39.firebaseapp.com",
      databaseURL: "https://fintrack-42a39-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fintrack-42a39",
      storageBucket: "fintrack-42a39.firebasestorage.app",
      messagingSenderId: "748412377392",
      appId: "1:748412377392:web:918cc14cfcada4495fd0f5",
      measurementId: "G-C0Y0G7C63V"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    // Types (Constants in JS)
    const TransactionType = {
      INCOME: 'income',
      EXPENSE: 'expense',
      BILL_PAYMENT: 'bill_payment'
    };

    const Frequency = {
      ONCE: 'once',
      MONTHLY: 'monthly',
      SEMI_MONTHLY: 'semi_monthly'
    };

    /***********************************************************
     * SERVICES
     ***********************************************************/
    const signInWithGoogle = async () => {
      try {
        await signInWithPopup(auth, googleProvider);
      } catch (error) {
        console.error("Error signing in", error);
        alert("Failed to sign in: " + error.message);
      }
    };

    const logOut = async () => {
      try {
        await firebaseSignOut(auth);
      } catch (error) {
        console.error("Error signing out", error);
      }
    };

    const analyzeFinances = async (settings, bills, transactions) => {
      // Use prompt/localStorage for key in this static demo
      let apiKey = localStorage.getItem('GEMINI_API_KEY');
      if (!apiKey) {
        apiKey = prompt("Please enter your Google Gemini API Key to use AI features:");
        if (apiKey) localStorage.setItem('GEMINI_API_KEY', apiKey);
      }
      
      if (!apiKey) return "API Key is required for AI advice.";

      const ai = new GoogleGenAI({ apiKey: apiKey });

      // Filter recent transactions (last 30 days)
      const now = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(now.getDate() - 30);

      const recentTx = transactions.filter(t => new Date(t.date) >= thirtyDaysAgo);
      
      const prompt = `
        You are a financial advisor. Here is the user's financial data for the last 30 days:
        
        Monthly Base Income: ${settings.monthlyIncome}
        Pay Dates: ${settings.payDate1}th and ${settings.payDate2}th
        
        Recurring Bills:
        ${bills.map(b => `- ${b.name}: ${b.amount} (Due day: ${b.dueDay})`).join('\n')}
        
        Recent Transactions:
        ${recentTx.map(t => `- ${t.date}: ${t.description} (${t.type}) - ${t.amount}`).join('\n')}
        
        Please provide a concise summary of their financial health, point out any excessive spending, and give 3 actionable tips to save money or improve their budget. Keep it under 200 words.
      `;

      try {
        const response = await ai.models.generateContent({
          model: 'gemini-2.5-flash',
          contents: prompt,
        });
        return response.text || "Could not generate advice.";
      } catch (error) {
        console.error("Gemini Error:", error);
        if (error.message.includes('403') || error.message.includes('key')) {
           localStorage.removeItem('GEMINI_API_KEY'); // Reset invalid key
           return "Invalid API Key. Please try again.";
        }
        return "Sorry, I encountered an error analyzing your data.";
      }
    };

    /***********************************************************
     * CONTEXTS
     ***********************************************************/
    
    // --- Auth Context ---
    const AuthContext = createContext({ user: null, loading: true });
    const useAuth = () => useContext(AuthContext);

    const AuthProvider = ({ children }) => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
          setUser(currentUser);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      return (
        <AuthContext.Provider value={{ user, loading }}>
          {children}
        </AuthContext.Provider>
      );
    };

    // --- Finance Context ---
    const defaultSettings = {
      monthlyIncome: 0,
      payDate1: 15,
      payDate2: 30
    };

    const FinanceContext = createContext(undefined);
    const useFinance = () => {
      const context = useContext(FinanceContext);
      if (!context) throw new Error("useFinance must be used within FinanceProvider");
      return context;
    };

    const FinanceProvider = ({ children }) => {
      const { user } = useAuth();
      const [settings, setSettings] = useState(defaultSettings);
      const [bills, setBills] = useState([]);
      const [transactions, setTransactions] = useState([]);
      const [loadingData, setLoadingData] = useState(true);

      useEffect(() => {
        if (!user) {
          setBills([]);
          setTransactions([]);
          setSettings(defaultSettings);
          setLoadingData(false);
          return;
        }

        const userRef = ref(db, `users/${user.uid}`);
        
        const unsubscribe = onValue(userRef, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            setSettings(data.settings || defaultSettings);
            
            const loadedBills = [];
            if (data.bills) {
              Object.entries(data.bills).forEach(([key, val]) => {
                loadedBills.push({ ...val, id: key });
              });
            }
            setBills(loadedBills);

            const loadedTransactions = [];
            if (data.transactions) {
              Object.entries(data.transactions).forEach(([key, val]) => {
                loadedTransactions.push({ ...val, id: key });
              });
            }
            // Sort transactions by date descending
            loadedTransactions.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
            setTransactions(loadedTransactions);
          } else {
            setSettings(defaultSettings);
            setBills([]);
            setTransactions([]);
          }
          setLoadingData(false);
        }, (error) => {
          console.error("Firebase Error:", error);
          setLoadingData(false);
        });

        return () => unsubscribe();
      }, [user]);

      const updateSettings = async (newSettings) => {
        if (!user) return;
        await set(ref(db, `users/${user.uid}/settings`), newSettings);
      };

      const addBill = async (bill) => {
        if (!user) return;
        const newBillRef = push(ref(db, `users/${user.uid}/bills`));
        await set(newBillRef, bill);
      };

      const updateBill = async (id, bill) => {
        if (!user) return;
        await update(ref(db, `users/${user.uid}/bills/${id}`), bill);
      };

      const deleteBill = async (id) => {
        if (!user) return;
        await remove(ref(db, `users/${user.uid}/bills/${id}`));
      };

      const addTransaction = async (transaction) => {
        if (!user) return;
        const newTxRef = push(ref(db, `users/${user.uid}/transactions`));
        await set(newTxRef, transaction);
      };

      const updateTransaction = async (id, transaction) => {
        if (!user) return;
        await update(ref(db, `users/${user.uid}/transactions/${id}`), transaction);
      };

      const deleteTransaction = async (id) => {
        if (!user) return;
        await remove(ref(db, `users/${user.uid}/transactions/${id}`));
      };

      return (
        <FinanceContext.Provider value={{
          settings, bills, transactions, updateSettings, addBill, updateBill, 
          deleteBill, addTransaction, updateTransaction, deleteTransaction, loadingData
        }}>
          {children}
        </FinanceContext.Provider>
      );
    };

    /***********************************************************
     * COMPONENTS
     ***********************************************************/

    const Layout = ({ children }) => {
      const location = useLocation();
      const { user } = useAuth();

      const navItems = [
        { path: '/', label: 'Dashboard', icon: <LayoutDashboard size={20} /> },
        { path: '/bills', label: 'Bills & Expenses', icon: <Receipt size={20} /> },
        { path: '/forecast', label: '3-Month Forecast', icon: <CalendarClock size={20} /> },
      ];

      return (
        <div className="flex flex-col md:flex-row min-h-screen text-gray-100">
          {/* Sidebar */}
          <aside className="w-full md:w-64 bg-surface border-b md:border-b-0 md:border-r border-gray-700 flex flex-col shrink-0">
            <div className="p-6 flex items-center gap-2 border-b border-gray-700">
              <IconPieChart className="text-primary" size={28} />
              <h1 className="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                FinTrack AI
              </h1>
            </div>

            <nav className="flex-1 p-4 space-y-2">
              {navItems.map((item) => (
                <Link
                  key={item.path}
                  to={item.path}
                  className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${
                    location.pathname === item.path
                      ? 'bg-primary/20 text-primary border border-primary/30'
                      : 'hover:bg-gray-700 text-gray-300'
                  }`}
                >
                  {item.icon}
                  <span className="font-medium">{item.label}</span>
                </Link>
              ))}
            </nav>

            <div className="p-4 border-t border-gray-700">
              <div className="flex items-center gap-3 mb-4 px-2">
                <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-xs font-bold">
                  {user?.displayName ? user.displayName.charAt(0) : 'U'}
                </div>
                <div className="overflow-hidden">
                  <p className="text-sm font-medium truncate">{user?.displayName || 'User'}</p>
                  <p className="text-xs text-gray-500 truncate">{user?.email}</p>
                </div>
              </div>
              <button
                onClick={logOut}
                className="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition-colors text-sm font-medium"
              >
                <LogOut size={16} />
                Sign Out
              </button>
            </div>
          </aside>

          {/* Main Content */}
          <main className="flex-1 overflow-y-auto p-4 md:p-8 bg-background h-[calc(100vh-64px)] md:h-screen">
            <div className="max-w-6xl mx-auto space-y-6 pb-20 md:pb-0">
              {children}
            </div>
          </main>
        </div>
      );
    };

    /***********************************************************
     * PAGES
     ***********************************************************/

    const Dashboard = () => {
      const { transactions, addTransaction, updateTransaction, deleteTransaction, settings, bills } = useFinance();
      const [showModal, setShowModal] = useState(false);
      const [aiAdvice, setAiAdvice] = useState('');
      const [loadingAi, setLoadingAi] = useState(false);
      
      // Current Month Data
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      const monthlyTransactions = useMemo(() => {
        return transactions.filter(t => {
          const d = new Date(t.date);
          return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
        });
      }, [transactions, currentMonth, currentYear]);

      const totalIncome = monthlyTransactions
        .filter(t => t.type === TransactionType.INCOME)
        .reduce((sum, t) => sum + t.amount, 0);

      const totalExpenses = monthlyTransactions
        .filter(t => t.type === TransactionType.EXPENSE || t.type === TransactionType.BILL_PAYMENT)
        .reduce((sum, t) => sum + t.amount, 0);

      const netCash = totalIncome - totalExpenses;

      // Expenses Breakdown for Chart
      const expensesByCategory = useMemo(() => {
        const data = {};
        monthlyTransactions
          .filter(t => t.type === TransactionType.EXPENSE || t.type === TransactionType.BILL_PAYMENT)
          .forEach(t => {
            const cat = t.category || 'Uncategorized';
            data[cat] = (data[cat] || 0) + t.amount;
          });
        return Object.entries(data).map(([name, value]) => ({ name, value }));
      }, [monthlyTransactions]);

      const COLORS = ['#3b82f6', '#8b5cf6', '#ef4444', '#f59e0b', '#10b981', '#ec4899'];

      // State for new manual expense
      const [newExpense, setNewExpense] = useState({
        description: '',
        amount: '',
        category: 'General',
        date: new Date().toISOString().split('T')[0]
      });
      const [editingId, setEditingId] = useState(null);

      const handleSaveExpense = async (e) => {
        e.preventDefault();
        if (!newExpense.description || !newExpense.amount) return;

        const payload = {
          description: newExpense.description,
          amount: parseFloat(newExpense.amount),
          category: newExpense.category,
          date: newExpense.date,
          type: TransactionType.EXPENSE,
        };

        if (editingId) {
          await updateTransaction(editingId, payload);
          setEditingId(null);
        } else {
          await addTransaction(payload);
        }
        
        setNewExpense({ description: '', amount: '', category: 'General', date: new Date().toISOString().split('T')[0] });
        setShowModal(false);
      };

      const handleEdit = (t) => {
        setNewExpense({
          description: t.description,
          amount: t.amount.toString(),
          category: t.category || 'General',
          date: t.date
        });
        setEditingId(t.id);
        setShowModal(true);
      };

      const handleGetAdvice = async () => {
        setLoadingAi(true);
        const advice = await analyzeFinances(settings, bills, transactions);
        setAiAdvice(advice);
        setLoadingAi(false);
      };

      return (
        <div className="space-y-6 animate-in fade-in duration-500">
          {/* Top Stats */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="bg-surface p-6 rounded-xl border border-gray-700 shadow-lg">
              <p className="text-gray-400 text-sm font-medium uppercase">Net Cash (This Month)</p>
              <h2 className={`text-3xl font-bold mt-2 ${netCash >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                ${netCash.toFixed(2)}
              </h2>
            </div>
            <div className="bg-surface p-6 rounded-xl border border-gray-700 shadow-lg">
              <p className="text-gray-400 text-sm font-medium uppercase">Total Expenses</p>
              <h2 className="text-3xl font-bold mt-2 text-red-400">
                ${totalExpenses.toFixed(2)}
              </h2>
            </div>
            <div className="bg-surface p-6 rounded-xl border border-gray-700 shadow-lg">
              <p className="text-gray-400 text-sm font-medium uppercase">Total Income</p>
              <h2 className="text-3xl font-bold mt-2 text-blue-400">
                ${totalIncome.toFixed(2)}
              </h2>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Unplanned Expenses List */}
            <div className="lg:col-span-2 bg-surface p-6 rounded-xl border border-gray-700 shadow-lg">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-lg font-bold text-white">Unplanned Expenses & Activity</h3>
                <button 
                  onClick={() => { setEditingId(null); setShowModal(true); }}
                  className="flex items-center gap-2 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition"
                >
                  <Plus size={16} /> Add Expense
                </button>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full text-left border-collapse">
                  <thead>
                    <tr className="text-gray-400 text-sm border-b border-gray-700">
                      <th className="py-3 font-medium">Date</th>
                      <th className="py-3 font-medium">Description</th>
                      <th className="py-3 font-medium">Category</th>
                      <th className="py-3 font-medium text-right">Amount</th>
                      <th className="py-3 font-medium text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="text-sm text-gray-300">
                    {monthlyTransactions.length === 0 ? (
                      <tr><td colSpan={5} className="py-4 text-center text-gray-500">No transactions this month.</td></tr>
                    ) : (
                      monthlyTransactions.map((t) => (
                        <tr key={t.id} className="border-b border-gray-700/50 hover:bg-gray-700/20 group">
                          <td className="py-3">{t.date}</td>
                          <td className="py-3 font-medium text-white">{t.description}</td>
                          <td className="py-3">
                            <span className="px-2 py-1 rounded-full bg-gray-700 text-xs text-gray-300">
                              {t.category || (t.type === TransactionType.BILL_PAYMENT ? 'Bill' : 'General')}
                            </span>
                          </td>
                          <td className={`py-3 text-right font-bold ${t.type === TransactionType.INCOME ? 'text-green-400' : 'text-white'}`}>
                            {t.type === TransactionType.INCOME ? '+' : '-'}${t.amount.toFixed(2)}
                          </td>
                          <td className="py-3 text-right">
                            <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                              <button onClick={() => handleEdit(t)} className="p-1 hover:text-blue-400"><Edit2 size={14} /></button>
                              <button onClick={() => deleteTransaction(t.id)} className="p-1 hover:text-red-400"><Trash2 size={14} /></button>
                            </div>
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Charts & AI */}
            <div className="space-y-6">
              {/* Chart */}
              <div className="bg-surface p-6 rounded-xl border border-gray-700 shadow-lg min-h-[300px]">
                <h3 className="text-lg font-bold text-white mb-4">Expense Breakdown</h3>
                {expensesByCategory.length > 0 ? (
                  <ResponsiveContainer width="100%" height={250}>
                    <PieChart>
                      <Pie
                        data={expensesByCategory}
                        cx="50%"
                        cy="50%"
                        innerRadius={60}
                        outerRadius={80}
                        paddingAngle={5}
                        dataKey="value"
                      >
                        {expensesByCategory.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Pie>
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#1e293b', borderColor: '#374151', color: '#fff' }}
                        itemStyle={{ color: '#fff' }}
                      />
                      <Legend />
                    </PieChart>
                  </ResponsiveContainer>
                ) : (
                  <div className="h-full flex items-center justify-center text-gray-500">No data to display</div>
                )}
              </div>

              {/* AI Advisor */}
              <div className="bg-gradient-to-br from-indigo-900 to-surface p-6 rounded-xl border border-indigo-700/50 shadow-lg">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-lg font-bold text-white flex items-center gap-2">
                    <Sparkles size={18} className="text-yellow-400" /> AI Insights
                  </h3>
                  <button 
                    onClick={handleGetAdvice}
                    disabled={loadingAi}
                    className="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded-full disabled:opacity-50"
                  >
                    {loadingAi ? 'Thinking...' : 'Analyze'}
                  </button>
                </div>
                <p className="text-sm text-gray-300 leading-relaxed">
                  {aiAdvice || "Click analyze to get AI-powered insights on your spending habits and budget."}
                </p>
              </div>
            </div>
          </div>

          {/* Manual Expense Modal */}
          {showModal && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
              <div className="bg-surface w-full max-w-md rounded-xl border border-gray-700 shadow-2xl p-6">
                <h3 className="text-xl font-bold mb-4">{editingId ? 'Edit Transaction' : 'Add Manual Expense'}</h3>
                <form onSubmit={handleSaveExpense} className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">Description</label>
                    <input 
                      type="text" 
                      value={newExpense.description}
                      onChange={(e) => setNewExpense({...newExpense, description: e.target.value})}
                      className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                      required
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-400 mb-1">Amount</label>
                      <input 
                        type="number" 
                        step="0.01"
                        value={newExpense.amount}
                        onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})}
                        className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-400 mb-1">Category</label>
                      <select 
                        value={newExpense.category}
                        onChange={(e) => setNewExpense({...newExpense, category: e.target.value})}
                        className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                      >
                        <option>General</option>
                        <option>Food</option>
                        <option>Transport</option>
                        <option>Shopping</option>
                        <option>Entertainment</option>
                        <option>Health</option>
                        <option>Income (Adjustment)</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">Date</label>
                    <input 
                      type="date" 
                      value={newExpense.date}
                      onChange={(e) => setNewExpense({...newExpense, date: e.target.value})}
                      className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                      required
                    />
                  </div>
                  <div className="flex justify-end gap-3 mt-6">
                    <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                    <button type="submit" className="px-4 py-2 bg-primary hover:bg-blue-600 text-white rounded-lg font-medium">
                      {editingId ? 'Update' : 'Add Expense'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    const Bills = () => {
      const { bills, addBill, updateBill, deleteBill, transactions, addTransaction, deleteTransaction } = useFinance();
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingBillId, setEditingBillId] = useState(null);
      const [formData, setFormData] = useState({
        name: '',
        amount: 0,
        dueDay: 1,
        frequency: Frequency.MONTHLY,
        terminationDate: ''
      });

      // Current viewing month
      const [viewDate, setViewDate] = useState(new Date());
      const currentMonth = viewDate.getMonth();
      const currentYear = viewDate.getFullYear();

      // Helper: Check if a bill is paid for the current viewing month
      const getBillPaymentStatus = (bill) => {
        const payment = transactions.find(t => {
          const tDate = new Date(t.date);
          return (
            t.relatedBillId === bill.id &&
            t.type === TransactionType.BILL_PAYMENT &&
            tDate.getMonth() === currentMonth &&
            tDate.getFullYear() === currentYear
          );
        });
        return payment;
      };

      const handleMarkAsPaid = async (bill) => {
        const existingPayment = getBillPaymentStatus(bill);
        
        if (existingPayment) {
          if (window.confirm(`Unmark ${bill.name} as paid for this month?`)) {
            await deleteTransaction(existingPayment.id);
          }
        } else {
          const dueDay = Math.min(bill.dueDay, new Date(currentYear, currentMonth + 1, 0).getDate());
          const payDate = new Date(currentYear, currentMonth, dueDay);
          
          await addTransaction({
            type: TransactionType.BILL_PAYMENT,
            amount: bill.amount,
            date: payDate.toISOString().split('T')[0],
            description: `Payment for ${bill.name}`,
            relatedBillId: bill.id,
            category: 'Bills'
          });
        }
      };

      const handleSaveBill = async (e) => {
        e.preventDefault();
        if (!formData.name || !formData.amount) return;

        const payload = {
          name: formData.name,
          amount: Number(formData.amount),
          dueDay: Number(formData.dueDay),
          frequency: formData.frequency,
          terminationDate: formData.terminationDate || undefined
        };

        if (editingBillId) {
          await updateBill(editingBillId, payload);
        } else {
          await addBill(payload);
        }
        setIsModalOpen(false);
        setEditingBillId(null);
        setFormData({ name: '', amount: 0, dueDay: 1, frequency: Frequency.MONTHLY, terminationDate: '' });
      };

      const startEdit = (bill) => {
        setEditingBillId(bill.id);
        setFormData(bill);
        setIsModalOpen(true);
      };

      const activeBills = bills.filter(b => !b.isArchived);

      return (
        <div className="space-y-6 animate-in fade-in duration-500">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h2 className="text-2xl font-bold text-white">Bills & Recurring Expenses</h2>
              <div className="flex items-center gap-2 mt-2">
                <button onClick={() => setViewDate(new Date(currentYear, currentMonth - 1, 1))} className="text-gray-400 hover:text-white">&lt;</button>
                <span className="text-primary font-medium">
                  {viewDate.toLocaleDateString('default', { month: 'long', year: 'numeric' })}
                </span>
                <button onClick={() => setViewDate(new Date(currentYear, currentMonth + 1, 1))} className="text-gray-400 hover:text-white">&gt;</button>
              </div>
            </div>
            <button 
              onClick={() => { setEditingBillId(null); setFormData({ name: '', amount: 0, dueDay: 1, frequency: Frequency.MONTHLY }); setIsModalOpen(true); }}
              className="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition"
            >
              <Plus size={18} /> Add Bill
            </button>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            {activeBills.map(bill => {
              const payment = getBillPaymentStatus(bill);
              const isPaid = !!payment;
              
              // Check if terminated
              if (bill.terminationDate && new Date(bill.terminationDate) < new Date(currentYear, currentMonth, 1)) {
                return null;
              }

              return (
                <div key={bill.id} className={`p-5 rounded-xl border transition-all ${isPaid ? 'bg-surface/50 border-green-500/30' : 'bg-surface border-gray-700'}`}>
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className="font-bold text-lg text-white">{bill.name}</h3>
                        <span className="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-300 uppercase">{bill.frequency}</span>
                      </div>
                      <p className="text-2xl font-bold text-gray-200">${bill.amount.toFixed(2)}</p>
                      <div className="flex items-center gap-2 mt-2 text-sm text-gray-400">
                        <AlertCircle size={14} /> Due day: {bill.dueDay}
                        {bill.terminationDate && <span className="text-red-400 ml-2">Ends: {bill.terminationDate}</span>}
                      </div>
                    </div>

                    <div className="flex flex-col gap-2 items-end">
                      <button
                        onClick={() => handleMarkAsPaid(bill)}
                        className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all ${
                          isPaid 
                            ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30' 
                            : 'bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white'
                        }`}
                      >
                        <CheckCircle size={16} /> {isPaid ? 'Paid' : 'Mark Paid'}
                      </button>
                      <div className="flex gap-1 mt-2">
                        <button onClick={() => startEdit(bill)} className="p-2 text-gray-500 hover:text-blue-400"><Edit2 size={16} /></button>
                        <button onClick={() => deleteBill(bill.id)} className="p-2 text-gray-500 hover:text-red-400"><Trash2 size={16} /></button>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
            {activeBills.length === 0 && (
              <div className="col-span-full text-center py-10 text-gray-500 bg-surface/30 rounded-xl border border-dashed border-gray-700">
                No recurring bills set up.
              </div>
            )}
          </div>

          {/* Modal */}
          {isModalOpen && (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
              <div className="bg-surface w-full max-w-md rounded-xl border border-gray-600 shadow-2xl p-6">
                <h3 className="text-xl font-bold mb-4">{editingBillId ? 'Edit Bill' : 'Add New Bill'}</h3>
                <form onSubmit={handleSaveBill} className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">Bill Name</label>
                    <input 
                      type="text" 
                      required
                      value={formData.name}
                      onChange={e => setFormData({...formData, name: e.target.value})}
                      className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-400 mb-1">Amount</label>
                      <input 
                        type="number" 
                        step="0.01"
                        required
                        value={formData.amount}
                        onChange={e => setFormData({...formData, amount: parseFloat(e.target.value)})}
                        className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-400 mb-1">Due Day (1-31)</label>
                      <input 
                        type="number" 
                        min="1" max="31"
                        required
                        value={formData.dueDay}
                        onChange={e => setFormData({...formData, dueDay: parseInt(e.target.value)})}
                        className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">Frequency</label>
                    <select
                      value={formData.frequency}
                      onChange={e => setFormData({...formData, frequency: e.target.value})}
                      className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                    >
                      <option value={Frequency.MONTHLY}>Monthly</option>
                      <option value={Frequency.SEMI_MONTHLY}>Semi-Monthly</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-400 mb-1">Termination Date (Optional)</label>
                    <input 
                      type="date"
                      value={formData.terminationDate || ''}
                      onChange={e => setFormData({...formData, terminationDate: e.target.value})}
                      className="w-full bg-background border border-gray-600 rounded-lg p-2 text-white focus:border-primary outline-none"
                    />
                  </div>
                  <div className="flex justify-end gap-3 mt-6">
                    <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                    <button type="submit" className="px-4 py-2 bg-primary hover:bg-blue-600 text-white rounded-lg font-medium">Save</button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    const Forecast = () => {
      const { settings, updateSettings, bills, transactions, addTransaction, updateTransaction } = useFinance();
      const [showSettings, setShowSettings] = useState(false);
      const [tempSettings, setTempSettings] = useState(settings);

      // Sync temp settings when global settings load
      useEffect(() => {
        setTempSettings(settings);
      }, [settings]);

      // Generate Forecast Data for next 3 months
      const generateForecast = () => {
        const result = {};
        const now = new Date();

        // Loop for current month + 2 future months
        for (let i = 0; i < 3; i++) {
          const targetDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
          const monthKey = targetDate.toLocaleString('default', { month: 'long', year: 'numeric' });
          const items = [];
          const monthIndex = targetDate.getMonth();
          const year = targetDate.getFullYear();

          // 1. Income Projections (Semi-monthly split)
          const incomePerPaycheck = settings.monthlyIncome / 2;
          const payDays = [settings.payDate1, settings.payDate2];
          
          payDays.forEach((day, idx) => {
            // Correct day validation
            const validDay = Math.min(day, new Date(year, monthIndex + 1, 0).getDate());
            const dateStr = new Date(year, monthIndex, validDay).toISOString().split('T')[0];
            
            // Check if actual income exists for this approximate date
            const relatedId = `income-${year}-${monthIndex}-${idx}`; // Virtual ID for linking
            const actualTx = transactions.find(t => 
                t.type === TransactionType.INCOME && 
                t.category === 'Salary' && 
                t.date === dateStr 
            );

            if (actualTx) {
                items.push({
                    date: dateStr,
                    description: `Salary Payout #${idx + 1} (Received)`,
                    amount: actualTx.amount,
                    type: TransactionType.INCOME,
                    isActual: true,
                    id: actualTx.id,
                    relatedId
                });
            } else {
                items.push({
                    date: dateStr,
                    description: `Salary Payout #${idx + 1} (Estimated)`,
                    amount: incomePerPaycheck,
                    type: TransactionType.INCOME,
                    isActual: false,
                    relatedId
                });
            }
          });

          // 2. Bill Projections
          bills.forEach(bill => {
            if (bill.terminationDate && new Date(bill.terminationDate) < targetDate) return;

            const dueDay = Math.min(bill.dueDay, new Date(year, monthIndex + 1, 0).getDate());
            const dateStr = new Date(year, monthIndex, dueDay).toISOString().split('T')[0];
            
            // Check actual payment
            const actualTx = transactions.find(t => 
                t.relatedBillId === bill.id && 
                t.type === TransactionType.BILL_PAYMENT &&
                new Date(t.date).getMonth() === monthIndex &&
                new Date(t.date).getFullYear() === year
            );

            if (actualTx) {
                items.push({
                    date: actualTx.date,
                    description: `${bill.name} (Paid)`,
                    amount: actualTx.amount,
                    type: TransactionType.BILL_PAYMENT,
                    isActual: true,
                    id: actualTx.id,
                    relatedId: bill.id
                });
            } else {
                items.push({
                    date: dateStr,
                    description: `${bill.name} (Due)`,
                    amount: bill.amount,
                    type: TransactionType.BILL_PAYMENT,
                    isActual: false,
                    relatedId: bill.id
                });
            }
          });

          // Sort by date
          items.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
          result[monthKey] = items;
        }
        return result;
      };

      const forecastData = generateForecast();

      // Handle Marking Income as Received or Editing Actual Amount
      const handleIncomeAction = async (item, newAmount) => {
        if (item.type !== TransactionType.INCOME) return;

        if (item.isActual && item.id) {
            // Update existing
            await updateTransaction(item.id, { amount: newAmount || item.amount });
        } else {
            // Create new
            await addTransaction({
                type: TransactionType.INCOME,
                amount: newAmount || item.amount,
                date: item.date,
                description: item.description.replace('(Estimated)', '(Received)'),
                category: 'Salary'
            });
        }
      };

      const [editingIncomeId, setEditingIncomeId] = useState(null);
      const [editAmount, setEditAmount] = useState('');

      const startEditIncome = (item) => {
        setEditingIncomeId(item.relatedId || null);
        setEditAmount(item.amount.toString());
      };

      const saveIncomeEdit = async (item) => {
        const val = parseFloat(editAmount);
        if (isNaN(val)) return;
        await handleIncomeAction(item, val);
        setEditingIncomeId(null);
      };

      const saveSettings = async () => {
        await updateSettings(tempSettings);
        setShowSettings(false);
      };

      return (
        <div className="space-y-6 animate-in fade-in duration-500">
          <div className="flex justify-between items-center bg-surface p-6 rounded-xl border border-gray-700">
            <div>
              <h2 className="text-2xl font-bold text-white">3-Month Forecast Budget</h2>
              <p className="text-gray-400 text-sm">Projected cash flow based on recurring income and bills.</p>
            </div>
            <button 
              onClick={() => setShowSettings(!showSettings)}
              className="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition"
            >
              <Settings size={18} /> {showSettings ? 'Close Settings' : 'Income Settings'}
            </button>
          </div>

          {showSettings && (
            <div className="bg-surface p-6 rounded-xl border border-blue-500/50 shadow-lg animate-in fade-in slide-in-from-top-4">
              <h3 className="font-bold mb-4 text-blue-400">Income Configuration</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm text-gray-400 mb-1">Total Monthly Income</label>
                  <input 
                    type="number" 
                    value={tempSettings.monthlyIncome}
                    onChange={e => setTempSettings({...tempSettings, monthlyIncome: parseFloat(e.target.value)})}
                    className="w-full bg-background border border-gray-600 rounded-lg p-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-400 mb-1">1st Payout Date</label>
                  <input 
                    type="number" min="1" max="31"
                    value={tempSettings.payDate1}
                    onChange={e => setTempSettings({...tempSettings, payDate1: parseInt(e.target.value)})}
                    className="w-full bg-background border border-gray-600 rounded-lg p-2"
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-400 mb-1">2nd Payout Date</label>
                  <input 
                    type="number" min="1" max="31"
                    value={tempSettings.payDate2}
                    onChange={e => setTempSettings({...tempSettings, payDate2: parseInt(e.target.value)})}
                    className="w-full bg-background border border-gray-600 rounded-lg p-2"
                  />
                </div>
              </div>
              <div className="flex justify-end mt-4">
                <button onClick={saveSettings} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg">
                  <Save size={16} /> Save Settings
                </button>
              </div>
            </div>
          )}

          <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
            {Object.entries(forecastData).map(([month, items]) => {
              // Calculate projected totals for this month
              const projectedIncome = items.filter(i => i.type === TransactionType.INCOME).reduce((acc, i) => acc + i.amount, 0);
              const projectedExpense = items.filter(i => i.type !== TransactionType.INCOME).reduce((acc, i) => acc + i.amount, 0);
              const surplus = projectedIncome - projectedExpense;

              return (
                <div key={month} className="bg-surface rounded-xl border border-gray-700 overflow-hidden flex flex-col">
                  <div className="p-4 bg-gray-800 border-b border-gray-700">
                    <h3 className="text-lg font-bold text-center text-white">{month}</h3>
                    <div className="flex justify-between mt-2 text-xs font-medium px-2">
                       <span className="text-green-400">In: ${projectedIncome.toFixed(0)}</span>
                       <span className={`${surplus >= 0 ? 'text-blue-400' : 'text-red-400'}`}>Net: ${surplus.toFixed(0)}</span>
                       <span className="text-red-400">Out: ${projectedExpense.toFixed(0)}</span>
                    </div>
                  </div>
                  <div className="flex-1 p-0 overflow-y-auto max-h-[500px]">
                    <table className="w-full text-sm">
                      <tbody>
                        {items.map((item, idx) => (
                          <tr key={idx} className="border-b border-gray-700/50 hover:bg-gray-700/20">
                            <td className="p-3 w-12 text-gray-500 font-mono text-xs">
                                {new Date(item.date).getDate()}
                            </td>
                            <td className="p-3">
                                <div className="font-medium text-gray-200">{item.description}</div>
                                <div className="text-xs text-gray-500 capitalize">{item.type.replace('_', ' ')}</div>
                            </td>
                            <td className="p-3 text-right">
                                {editingIncomeId === item.relatedId ? (
                                    <div className="flex items-center gap-1 justify-end">
                                        <input 
                                            type="number" 
                                            className="w-20 bg-background border border-gray-600 rounded px-1 text-right"
                                            value={editAmount}
                                            onChange={e => setEditAmount(e.target.value)}
                                            autoFocus
                                        />
                                        <button onClick={() => saveIncomeEdit(item)} className="text-green-400"><Check size={16}/></button>
                                    </div>
                                ) : (
                                    <div className="flex items-center justify-end gap-2">
                                        <span className={`font-bold ${item.type === TransactionType.INCOME ? 'text-green-400' : 'text-white'}`}>
                                            {item.type === TransactionType.INCOME ? '+' : '-'}${item.amount.toFixed(2)}
                                        </span>
                                        {item.type === TransactionType.INCOME && (
                                            <button onClick={() => startEditIncome(item)} className="text-gray-500 hover:text-blue-400">
                                                <Edit2 size={12} />
                                            </button>
                                        )}
                                    </div>
                                )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    /***********************************************************
     * APP ROUTING
     ***********************************************************/
    
    const PrivateRoute = ({ children }) => {
      const { user, loading } = useAuth();

      if (loading) {
        return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-blue-500">Loading Auth...</div>;
      }

      if (!user) {
        return <Navigate to="/login" />;
      }

      return <Layout>{children}</Layout>;
    };

    const Login = () => {
      const { user, loading } = useAuth();
      
      if (loading) return null;
      if (user) return <Navigate to="/" />;

      return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 animate-in fade-in zoom-in duration-500">
          <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-slate-700 text-center">
            <div className="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
              <Wallet className="text-blue-500" size={32} />
            </div>
            <h1 className="text-3xl font-bold text-white mb-2">FinTrack AI</h1>
            <p className="text-slate-400 mb-8">Master your money with intelligent tracking and forecasting.</p>
            <button 
              onClick={signInWithGoogle}
              className="w-full bg-white text-slate-900 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-100 transition-colors"
            >
              <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-6 h-6" alt="Google" />
              Sign in with Google
            </button>
          </div>
        </div>
      );
    };

    const App = () => {
      return (
        <AuthProvider>
          <FinanceProvider>
            <HashRouter>
              <Routes>
                <Route path="/login" element={<Login />} />
                <Route path="/" element={<PrivateRoute><Dashboard /></PrivateRoute>} />
                <Route path="/bills" element={<PrivateRoute><Bills /></PrivateRoute>} />
                <Route path="/forecast" element={<PrivateRoute><Forecast /></PrivateRoute>} />
              </Routes>
            </HashRouter>
          </FinanceProvider>
        </AuthProvider>
      );
    };

    const rootElement = document.getElementById('root');
    if (!rootElement) {
      throw new Error("Could not find root element to mount to");
    }

    const root = createRoot(rootElement);
    root.render(<App />);
    
    // Remove loader safely
    const loader = document.getElementById('loading-screen');
    if (loader) loader.style.display = 'none';
  </script>
</body>
</html>
